---
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import type { SEOProps } from "astro-seo";

const blogs = await getCollection("database");

export const getStaticPaths = async () => {
  const blogs = await getCollection("database");
  return blogs.map((blog) => ({
    params: {
      slug: blog.data.properties.Slug.rich_text[0].plain_text.replaceAll(
        '"',
        ""
      ),
    },
  }));
};

const { slug } = Astro.params;

const blog = blogs.filter(
  (blog) =>
    blog.data.properties.Slug.rich_text[0].plain_text.replaceAll('"', "") ===
    slug
)[0];

if (!slug || !blog || !blog.rendered?.html) return Astro.redirect("/404");

const title = blog.data.properties.Name.title.reduce(
  (acc: string, curr) => acc + curr.plain_text,
  ""
);
const description = blog.data.properties.Description.rich_text[0]?.plain_text;
const content = blog.rendered.html;
const image =
  blog.data.cover?.type === "external" ? blog.data.cover.external.url : "";

const SEO: SEOProps = {
  title,
  description,
  openGraph: {
    basic: {
      title,
      image,
      url: Astro.url,
      type: "article",
    },
  },
  twitter: {
    site: Astro.site?.toString(),
    title,
    description,
    image,
  },
};
---

<Layout {...SEO}>
  <section>
    <div class="pb-12">
      <h1 class="text-4xl font-bold text-red-500">{title}</h1>
    </div>
    <div
      class="prose text-red-50 prose-headings:text-red-50 prose-pre:bg-background prose-pre:border"
      set:html={content}
    />
  </section>
</Layout>
